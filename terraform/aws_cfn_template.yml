AWSTemplateFormatVersion: "2010-09-09"
Description: "SwiftLine Lex V2 Bot Definition via CloudFormation"

Parameters:
  BotName:
    Type: String
  LexRoleArn:
    Type: String
  LambdaFulfillmentArn:
    Type: String
  BotAliasName:
    Type: String

Resources:
  # ---------------------------------------------------------
  # 1. THE BOT
  # ---------------------------------------------------------
  LexBot:
    Type: "AWS::Lex::Bot"
    Properties:
      Name: !Ref BotName
      RoleArn: !Ref LexRoleArn
      DataPrivacy:
        ChildDirected: false
      IdleSessionTTLInSeconds: 300
      BotLocales:
        - LocaleId: "en_US"
          NluConfidenceThreshold: 0.40
          Intents:
            # === INTENT: Welcome / Main Menu ===
            - Name: "WelcomeIntent"
              SampleUtterances:
                - Utterance: "Hi"
                - Utterance: "Hello"
                - Utterance: "Main Menu"  # <--- Triggers when user clicks "Yes"
              FulfillmentCodeHook:
                Enabled: true 

            # === INTENT: Get Order Status ===
            - Name: "GetOrderStatus"
              SampleUtterances:
                - Utterance: "What is the status of my order {TrackingID}"
                - Utterance: "Track my order with ID {TrackingID}"
                - Utterance: "Where is my package"
                - Utterance: "Track order"
                - Utterance: "I want to track my order"
              FulfillmentCodeHook:
                Enabled: true
              Slots:
                - Name: "TrackingID"
                  SlotTypeName: "AMAZON.AlphaNumeric"
                  ValueElicitationSetting:
                    SlotConstraint: "Required"
                    PromptSpecification:
                      MaxRetries: 2
                      MessageGroupsList:
                        - Message:
                            PlainTextMessage:
                              Value: "Please provide your tracking ID (e.g., SWL-2024-AIR-001234)."
              SlotPriorities:
                - Priority: 1
                  SlotName: "TrackingID"

            # === INTENT: End Conversation (NEW) ===
            - Name: "EndConversationIntent"
              SampleUtterances:
                - Utterance: "No"
                - Utterance: "No thanks"
                - Utterance: "I am done"
                - Utterance: "Bye"
              FulfillmentCodeHook:
                Enabled: true

            # === INTENT: Fallback ===
            - Name: "FallbackIntent"
              ParentIntentSignature: "AMAZON.FallbackIntent"

  # ---------------------------------------------------------
  # 2. THE VERSION (Updated to V4)
  # ---------------------------------------------------------
  BotVersionV4:
    Type: "AWS::Lex::BotVersion"
    Properties:
      BotId: !Ref LexBot
      BotVersionLocaleSpecification:
        - LocaleId: "en_US"
          BotVersionLocaleDetails:
            SourceBotVersion: "DRAFT"
    Metadata:
      Comment: "Version 4 with Closing Loop"

  # ---------------------------------------------------------
  # 3. THE ALIAS (Points to V4)
  # ---------------------------------------------------------
  BotAlias:
    Type: "AWS::Lex::BotAlias"
    Properties:
      BotAliasName: !Ref BotAliasName
      BotId: !Ref LexBot
      BotVersion: !GetAtt BotVersionV4.BotVersion 
      BotAliasLocaleSettings:
        - LocaleId: "en_US"
          BotAliasLocaleSetting:
            Enabled: true
            CodeHookSpecification:
              LambdaCodeHook:
                CodeHookInterfaceVersion: "1.0"
                LambdaArn: !Ref LambdaFulfillmentArn

Outputs:
  BotId:
    Description: Lex Bot Id
    Value: !Ref LexBot
  BotAliasId:
    Description: Lex BotAlias Id
    Value: !Ref BotAlias
  BotAliasArn:
    Description: ARN of bot alias
    Value: !Sub "arn:aws:lex:${AWS::Region}:${AWS::AccountId}:bot-alias/${LexBot}/${BotAlias}"